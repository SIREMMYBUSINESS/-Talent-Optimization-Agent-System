```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Admin Audit Stream & Control</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding: 1rem; }
    #logs { white-space: pre-wrap; background: #f4f4f4; padding: 1rem; border-radius: 6px; height: 320px; overflow-y: auto; margin-bottom: 1rem; }
    #metrics { font-size: 0.9rem; color: #333; margin-top: 0.5rem; }
    .meta { font-size: 0.85rem; color: #666; margin-bottom: 0.5rem; }
    .controls { margin-bottom: 1rem; }
    input[type="text"], input[type="password"] { padding: 0.5rem; font-size: 1rem; width: 300px; }
    button { padding: 0.5rem 1rem; font-size: 1rem; }
  </style>
</head>
<body>
  <h2>Admin Audit Stream</h2>
  <div class="meta">Use this dashboard to connect to the SSE audit stream. In production prefer HttpOnly cookies; this demo stores JWT in localStorage for convenience.</div>

  <div class="controls">
    <div>
      <label>JWT (place token here for dev):</label><br/>
      <input id="jwtInput" type="text" placeholder="paste JWT here" />
      <button id="saveJwt">Save</button>
      <button id="clearJwt">Clear</button>
    </div>
    <div style="margin-top:0.5rem;">
      <button id="connectBtn">Connect Stream</button>
      <button id="disconnectBtn">Disconnect</button>
      <button id="refreshMetrics">Refresh Metrics</button>
    </div>
    <div id="authStatus" class="meta"></div>
  </div>

  <div id="logs">No connection yet.</div>

  <div id="metrics"></div>

  <script>
    (function () {
      const logsEl = document.getElementById('logs');
      const jwtInput = document.getElementById('jwtInput');
      const saveJwtBtn = document.getElementById('saveJwt');
      const clearJwtBtn = document.getElementById('clearJwt');
      const connectBtn = document.getElementById('connectBtn');
      const disconnectBtn = document.getElementById('disconnectBtn');
      const refreshMetricsBtn = document.getElementById('refreshMetrics');
      const metricsEl = document.getElementById('metrics');
      const authStatus = document.getElementById('authStatus');

      function appendLine(text, cls) {
        const node = document.createElement('div');
        if (cls) node.className = cls;
        node.textContent = text;
        logsEl.appendChild(node);
        logsEl.scrollTop = logsEl.scrollHeight;
      }

      function getJwt() {
        return localStorage.getItem('jwt');
      }

      function setJwt(val) {
        if (val) localStorage.setItem('jwt', val);
        else localStorage.removeItem('jwt');
      }

      saveJwtBtn.onclick = () => {
        setJwt(jwtInput.value.trim());
        authStatus.textContent = 'JWT saved (dev).';
      };
      clearJwtBtn.onclick = () => {
        setJwt(null);
        jwtInput.value = '';
        authStatus.textContent = 'JWT cleared.';
      };

      let es = null;
      let retryDelay = 1000;
      const maxDelay = 30000;
      let closedByClient = false;

      async function connect() {
        const token = getJwt();
        if (!token) {
          authStatus.textContent = 'No JWT found - paste token in field and Save.';
          return;
        }
        authStatus.textContent = 'Connecting...';
        // EventSource cannot set Authorization header; use query param. Ensure HTTPS in prod.
        const url = `/admin/audit-logs/stream?token=${encodeURIComponent(token)}`;

        try {
          es = new EventSource(url);
        } catch (err) {
          appendLine('[client] EventSource construction failed: ' + String(err), 'error');
          scheduleReconnect();
          return;
        }

        es.onopen = () => {
          retryDelay = 1000;
          authStatus.textContent = 'Connected';
          appendLine('[client] Connected to SSE stream');
        };

        es.onmessage = (ev) => {
          try {
            const obj = JSON.parse(ev.data);
            const ts = obj.timestamp || new Date().toISOString();
            const action = obj.action || obj.event_type || JSON.stringify(obj.metadata || {});
            appendLine(`[${ts}] ${action}`);
          } catch (err) {
            appendLine('[client] Invalid event data: ' + ev.data, 'error');
          }
        };

        es.onerror = (err) => {
          authStatus.textContent = 'Disconnected - retrying';
          appendLine('[client] Connection error; reconnecting...', 'error');
          if (es) try { es.close(); } catch (_) {}
          scheduleReconnect();
        };
      }

      function scheduleReconnect() {
        if (closedByClient) return;
        setTimeout(() => connect(), retryDelay);
        retryDelay = Math.min(maxDelay, Math.floor(retryDelay * 1.8));
      }

      function disconnect() {
        closedByClient = true;
        if (es) {
          try { es.close(); } catch (_) {}
          es = null;
        }
        authStatus.textContent = 'Disconnected (manual)';
      }

      connectBtn.onclick = () => { closedByClient = false; connect(); };
      disconnectBtn.onclick = () => { disconnect(); };

      async function fetchMetrics() {
        const token = getJwt();
        if (!token) {
          metricsEl.textContent = 'No JWT for metrics';
          return;
        }
        try {
          const res = await fetch('/admin/metrics', { headers: { Authorization: 'Bearer ' + token }});
          if (!res.ok) {
            metricsEl.textContent = 'Failed to fetch metrics: ' + res.status;
            return;
          }
          const js = await res.json();
          metricsEl.textContent = JSON.stringify(js, null, 2);
        } catch (err) {
          metricsEl.textContent = 'Metrics fetch error: ' + String(err);
        }
      }

      refreshMetricsBtn.onclick = () => fetchMetrics();

      // auto-refresh metrics every 15s
      setInterval(fetchMetrics, 15000);
      // show any saved token
      const saved = getJwt();
      if (saved) jwtInput.value = saved;

    })();
  </script>
</body>
</html>
